stages:
  - test

variables:
  INSTALL_PACKAGES: git gcc make cmake unzip
  BUNDLE_VERSION: 1.10.3-68-g618f48d

cache:
  key: $BUNDLE_VERSION
  paths:
    - tmp/sdk-1.10

test_enterprise-1.10:
  stage: test
  tags:
    - docker
  image: centos:7
  before_script:
    - yum -y install $INSTALL_PACKAGES
    - yum -y install git gcc make cmake unzip python python-pip
    - make tmp/sdk-1.10
    - source tmp/sdk-1.10/env.sh
    - tarantool -V
    - curl -sL https://rpm.nodesource.com/setup_8.x | bash -
    - yum -y install epel-release
    - yum -y install nodejs python36-pip
    - pip3.6 install -r test/python/requirements.txt
  script:
    - make ci_prepare
    - make lint test getting-started-test

test_opensource-1.10:
  stage: test
  tags:
    - docker
  image: centos:7
  before_script:
    - curl -s https://packagecloud.io/install/repositories/tarantool/1_10/script.rpm.sh | bash
    - yum -y install tarantool tarantool-devel
    - tarantool -V
    - yum -y install epel-release
    - yum -y install $INSTALL_PACKAGES python36-pip
    - pip3.6 install -r test/python/requirements.txt
  script:
    - make ci_prepare
    - make lint test getting-started-test

test_opensource-2.2:
  stage: test
  tags:
    - docker
  image: centos:7
  before_script:
    - curl -s https://packagecloud.io/install/repositories/tarantool/2_2/script.rpm.sh | bash
    - yum -y install tarantool tarantool-devel
    - tarantool -V
    - yum -y install epel-release
    - yum -y install $INSTALL_PACKAGES python36-pip
    - pip3.6 install -r test/python/requirements.txt
  script:
    - make ci_prepare
    - make lint test getting-started-test

.e2e-opensource-1.10:
  stage: test
  tags:
    - shell
    - vagrant
  before_script:
    - vagrant up
  script:
    - vagrant ssh centos < test/e2e/start-rpm.sh
    - vagrant ssh centos < test/e2e/test-cluster.sh
    - vagrant reload centos
    - sleep 1
    - vagrant ssh centos < test/e2e/test-cluster.sh
    - vagrant ssh centos < test/e2e/cleanup.sh

    - vagrant ssh ubuntu < test/e2e/start-deb.sh
    - vagrant ssh ubuntu < test/e2e/test-cluster.sh
    - vagrant reload ubuntu
    - sleep 1
    - vagrant ssh ubuntu < test/e2e/test-cluster.sh
    - vagrant ssh ubuntu < test/e2e/cleanup.sh
  after_script:
    - vagrant halt
    - vagrant destroy
